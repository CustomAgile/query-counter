<!DOCTYPE html>
<html>
<head>
    <title>query-counter-1.1.9</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Fri May 10 2019 09:28:41 GMT-0500 (-05) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Fri May 10 2019 09:28:41 GMT-0500 (-05)";
        var CHECKSUM = 58705451571;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Utils.AncestorPiAppFilter",{alias:"plugin.UtilsAncestorPiAppFilter",mixins:["Ext.AbstractPlugin","Rally.Messageable"],extend:"Ext.Component",statics:{RENDER_AREA_ID:"utils-ancestor-pi-app-filter"},config:{renderAreaId:"utils-ancestor-pi-app-filter",publisher:!1,allowNoEntry:!0,settingsConfig:{},ancestorLabel:"With ancestor",ancestorLabelWidth:110,ownerLabel:"and owned by",ownerOnlyLabel:"Owned by",ownerLabelWidth:110,labelStyle:"font-size: medium",singleRowMinWidth:840},portfolioItemTypes:[],readyDeferred:null,piTypesDeferred:null,isSubscriber:!1,changeSubscribers:[],publishedValue:{},constructor:function(e){this.callParent(arguments),this._setupPubSub(),Ext.tip.QuickTipManager.init()},initComponent:function(){this.callParent(arguments),this.addEvents("ready","select")},init:function(e){this.cmp=e,this.cmp.on("resize",this._onCmpResize,this),this.renderArea=this.cmp.down("#"+this.renderAreaId);var t=this.cmp.getSettingsFields;this.cmp.getSettingsFields=function(){return this._getSettingsFields(t.apply(e,arguments))}.bind(this);var i=this.cmp.defaultSettings;i["Utils.AncestorPiAppFilter.enableAncestorPiFilter2"]=!1,i["Utils.AncestorPiAppFilter.projectScope"]="current",this.cmp.setDefaultSettings(i),this._addControlCmp().then({scope:this,success:function(){this._setReady()}})},notifySubscribers:function(){var e=this._getValue();_.each(this.changeSubscribers,function(t){this.publish(t,e)},this)},getFilterForType:function(e){var t,i=e.toLowerCase(),r=this._getValue();if(r.piTypePath){var o,n=r.piTypePath,a=r.isPiSelected,s=r.pi,l=this._piTypeAncestors(i,n);if(a&&null!=s&&null!=l)(o=this._propertyPrefix(i,l))&&(t=new Rally.data.wsapi.Filter({property:o,value:s}));else null!=s&&(t=new Rally.data.wsapi.Filter({property:"ObjectID",value:0}))}return t},getIgnoreProjectScope:function(){return this._getValue().ignoreProjectScope},_setupPubSub:function(){this.publisher?(this.subscribe(this,"registerChangeSubscriber",function(e){_.contains(this.changeSubscribers,e)||this.changeSubscribers.push(e),this.publish(e,this._getValue())},this),this.publish("reRegisterChangeSubscriber")):(this.subscriberEventName=Rally.getApp().getAppId()+this.$className,this.subscribe(this,this.subscriberEventName,function(e){this.intervalTimer&&(clearInterval(this.intervalTimer),delete this.intervalTimer),this.isSubscriber||(this.isSubscriber=!0,this._hideControlCmp()),this.publishedValue=e,this._onSelect()},this),this.publish("registerChangeSubscriber",this.subscriberEventName),this.intervalTimer=setInterval(function(){this.publish("registerChangeSubscriber",this.subscriberEventName)}.bind(this),500),this.subscribe(this,"reRegisterChangeSubscriber",function(){this.publish("registerChangeSubscriber",this.subscriberEventName)},this))},_getValue:function(){var e={};if(this._isSubscriber())e=this.publishedValue||{};else{if(this.piTypeSelector){var t=this.piTypeSelector.getRecord();if(t){var i=t.get("TypePath"),r=this.piSelector.getRecord(),o=this.piSelector.getValue();_.merge(e,{piTypePath:i,isPiSelected:!!r,pi:o})}}e.ignoreProjectScope=this._ignoreProjectScope()}return e},_setReady:function(){this.ready=!0,this.fireEvent("ready",this)},_onSelect:function(){this.ready&&this.fireEvent("select",this)},_getSettingsFields:function(e){var t=Rally.getApp().getSettings();t.hasOwnProperty("Utils.AncestorPiAppFilter.projectScope")||(t["Utils.AncestorPiAppFilter.projectScope"]="user");var i=[{xtype:"rallycheckboxfield",id:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",name:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",fieldLabel:"Filter artifacts by ancestor portfolio item"},{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.defaultPiType",name:"Utils.AncestorPiAppFilter.defaultPiType",fieldLabel:"Default Portfolio Item type",valueField:"TypePath",allowNoEntry:!1,defaultSelectionPosition:"last",plugins:[]},{xtype:"radiogroup",fieldLabel:"Show artifacts from",columns:1,vertical:!0,allowBlank:!1,items:[{boxLabel:"User's current project(s).",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"current",checked:"current"===t["Utils.AncestorPiAppFilter.projectScope"]},{boxLabel:"All projects in workspace.",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"workspace",checked:"workspace"===t["Utils.AncestorPiAppFilter.projectScope"]},{boxLabel:"User selectable (either current project(s) or all projects in workspace).",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"user",checked:"user"===t["Utils.AncestorPiAppFilter.projectScope"]}],listeners:{scope:this,change:function(e,t){}}}];return(i=_.map(i,function(e){return _.merge(e,this.settingsConfig)},this)).concat(e||[])},_addControlCmp:function(){var e=Ext.create("Deft.Deferred"),t={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"},i=this.ownerLabelWidth;this.cmp.getWidth()<this.singleRowMinWidth&&(t="vbox",i=this.ancestorLabelWidth);var r=!1;0==this._showAncestorFilter()&&1==this._showIgnoreProjectScopeControl()&&(r=!0);var o={xtype:"container",id:"controlsArea",overflowX:"auto",layout:{type:"hbox",align:"top"},items:[{xtype:"container",id:"pubSubIndicatorArea",width:25,padding:"6 5 0 0",hidden:!this.publisher&&!this._isSubscriber(),items:[{xtype:"component",id:"publisherIndicator",html:'<span class="icon-bullhorn icon-large"></span>',hidden:!this.publisher},{xtype:"component",id:"subscriberIndicator",html:'<span class="icon-link icon-large"></span>',hidden:!this._isSubscriber()}]},{xtype:"container",id:"filtersArea",layout:t,items:[{xtype:"container",id:"ancestorFilterArea",layout:{type:"hbox",align:"middle"},items:[{xtype:"container",id:"piTypeArea",layout:{type:"hbox",align:"middle"}},{xtype:"container",id:"piSelectorArea",layout:{type:"hbox",align:"middle",padding:"0 0 0 5"}}]},{xtype:"container",id:"scopeControlArea",width:250,layout:{type:"hbox",align:"middle"},items:[{xtype:"rallycombobox",id:"ignoreScopeControl",stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.ignoreProjectScopeControl"),stateEvents:["select"],hidden:this._isSubscriber()||!this._showIgnoreProjectScopeControl(),displayField:"text",valueField:"value",labelStyle:this.labelStyle,labelWidth:i,fieldLabel:r?this.ownerOnlyLabel:this.ownerLabel,storeConfig:{fields:["text","value"],data:[{text:"Current Project(s)",value:!1},{text:"Any Project",value:!0}]},listeners:{scope:this,change:function(e,t){this._onSelect()}}}]}]}]};return this.renderArea&&(this.renderArea.setOverflowXY("auto","auto"),this.renderArea.add(o)),this._addTooltips(),Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(t){this.portfolioItemTypes=t,!this._isSubscriber()&&this._showAncestorFilter()?(this.piTypeSelector=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.piType",name:"Utils.AncestorPiAppFilter.piType",width:250,plugins:[],stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piType"),stateEvents:["select"],fieldLabel:this.ancestorLabel,labelWidth:this.ancestorLabelWidth,labelStyle:this.labelStyle,valueField:"TypePath",value:this._defaultPortfolioItemType(),allowNoEntry:!1,defaultSelectionPosition:"first",listeners:{scope:this,ready:function(t){t.addListener({scope:this,change:this._onPiTypeChange}),this._addPiSelector(t.getValue()).then({scope:this,success:function(){e.resolve()}})}}}),this.renderArea.down("#piTypeArea").add(this.piTypeSelector)):e.resolve()}}),e.promise},_addTooltips:function(){Ext.tip.QuickTipManager.register({target:"publisherIndicator",text:'This app broadcasts filter settings to any enabled ancestor filtered apps (indicated with <span class="icon-link icon-large"></span>)',showDelay:50,border:!0}),Ext.tip.QuickTipManager.register({target:"subscriberIndicator",text:'This app listens for filter settings from any enabled ancestor filter broadcast app (indicated with <span class="icon-bullhorn icon-large"></span>)',showDelay:50,border:!0})},_onCmpResize:function(e,t){var i={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"};t<this.singleRowMinWidth&&(i={type:"vbox"});var r=this.renderArea.down("#filtersArea");if(r){var o=this.renderArea.down("#controlsArea"),n={xtype:"container",id:"filtersArea",layout:i,items:r.removeAll(!1),hidden:r.isHidden()};o.remove(r,!1),o.add(n)}},_hideControlCmp:function(){this.renderArea&&(this.renderArea.down("#pubSubIndicatorArea").show(),this.renderArea.down("#subscriberIndicator").show(),this.renderArea.down("#filtersArea").hide())},_onPiTypeChange:function(e,t,i){t&&(this._removePiSelector(),this._addPiSelector(t).then({scope:this,success:function(){this._setReady()}}))},_removePiSelector:function(){this.renderArea.down("#piSelectorArea").removeAll()},_addPiSelector:function(e){var t=Ext.create("Deft.Deferred");return this.piSelector=Ext.create("Rally.ui.combobox.ArtifactSearchComboBox",{id:"Utils.AncestorPiAppFilter.piSelector",width:250,labelAlign:"top",storeConfig:{models:e,autoLoad:!0,context:{project:null}},stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piSelector"),stateEvents:["select"],valueField:"_ref",allowClear:!0,clearValue:null,allowNoEntry:this.allowNoEntry,noEntryValue:"",defaultSelectionPosition:null,listeners:{scope:this,select:function(e,t){this._onSelect()},ready:function(e,i){t.resolve()}}}),Ext.override(this.piSelector,{saveState:function(){var e,t=this,i=t.stateful&&t.getStateId(),r=t.hasListeners;i&&(e=t.getState()||{},r.beforestatesave&&!1===t.fireEvent("beforestatesave",t,e)||(Ext.state.Manager.set(i,e),r.statesave&&t.fireEvent("statesave",t,e)))}}),this.renderArea.down("#piSelectorArea").add(this.piSelector),t.promise},_showAncestorFilter:function(){return this.cmp.getSetting("Utils.AncestorPiAppFilter.enableAncestorPiFilter2")},_showIgnoreProjectScopeControl:function(){return"user"==this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")},_ignoreProjectScope:function(){var e=!1;return this._showIgnoreProjectScopeControl()?e=this.renderArea.down("#ignoreScopeControl").getValue():"workspace"==this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")&&(e=!0),e},_isSubscriber:function(){return this.isSubscriber},_defaultPortfolioItemType:function(){return this.cmp.getSetting("Utils.AncestorPiAppFilter.defaultPiType")},_propertyPrefix:function(e,t){var i;return"hierarchicalrequirement"===e||"userstory"===e?i=t[0].get("Name"):"defect"===e?i="Requirement."+t[0].get("Name"):Ext.String.startsWith(e,"portfolioitem")&&(i="Parent"),i&&_.forEach(t.slice(1),function(e){i+=".Parent"},this),i},_piTypeAncestors:function(e,t){var i,r,o=null;return _.contains(["hierarchicalrequirement","userstory","defect"],e)?(i=_.findIndex(this.portfolioItemTypes,function(e){return e.get("TypePath").toLowerCase()===t.toLowerCase()}),o=this.portfolioItemTypes.slice(0,i+1)):Ext.String.startsWith(e,"portfolioitem")&&(r=_.findIndex(this.portfolioItemTypes,function(t){return t.get("TypePath").toLowerCase()===e.toLowerCase()}))<(i=_.findIndex(this.portfolioItemTypes,function(e){return e.get("TypePath").toLowerCase()===t.toLowerCase()}))&&(o=this.portfolioItemTypes.slice(r+1,i+1)),o}});var saveAs=saveAs||function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=function(){return e.URL||e.webkitURL||e},i=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),r="download"in i,o=/constructor/i.test(e.HTMLElement)||e.safari,n=/CriOS\/[\d]+/.test(navigator.userAgent),a=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s=function(e){setTimeout(function(){"string"==typeof e?t().revokeObjectURL(e):e.remove()},4e4)},l=function(e,t,i){for(var r=(t=[].concat(t)).length;r--;){var o=e["on"+t[r]];if("function"==typeof o)try{o.call(e,i||e)}catch(e){a(e)}}},c=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},d=function(a,d,u){u||(a=c(a));var h,p=this,g="application/octet-stream"===a.type,f=function(){l(p,"writestart progress write writeend".split(" "))};if(p.readyState=p.INIT,r)return h=t().createObjectURL(a),void setTimeout(function(){var e,t;i.href=h,i.download=d,e=i,t=new MouseEvent("click"),e.dispatchEvent(t),f(),s(h),p.readyState=p.DONE});!function(){if((n||g&&o)&&e.FileReader){var i=new FileReader;return i.onloadend=function(){var t=n?i.result:i.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,p.readyState=p.DONE,f()},i.readAsDataURL(a),void(p.readyState=p.INIT)}h||(h=t().createObjectURL(a)),g?e.location.href=h:e.open(h,"_blank")||(e.location.href=h);p.readyState=p.DONE,f(),s(h)}()},u=d.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,i){return t=t||e.name||"download",i||(e=c(e)),navigator.msSaveOrOpenBlob(e,t)}:(u.abort=function(){},u.readyState=u.INIT=0,u.WRITING=1,u.DONE=2,u.error=u.onwritestart=u.onprogress=u.onwrite=u.onabort=u.onerror=u.onwriteend=null,function(e,t,i){return new d(e,t||e.name||"download",i)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs}),Ext.define("CArABU.technicalservices.FileUtilities",{singleton:!0,saveCSVToFile:function(e,t,i){void 0==i&&(i={type:"text/csv;charset=utf-8"});var r=new Blob([e],i);saveAs(r,t)},saveTextAsFile:function(e,t){var i=new Blob([e],{type:"text/plain"}),r=t,o=document.createElement("a");o.download=r,o.innerHTML="Download File",null!=window.webkitURL?o.href=window.webkitURL.createObjectURL(i):(o.href=window.URL.createObjectURL(i),o.onclick=destroyClickedElement,o.style.display="none",document.body.appendChild(o)),o.click()},destroyClickedElement:function(e){document.body.removeChild(e.target)},convertDataArrayToCSVText:function(e,t){var i="";return Ext.each(Object.keys(t),function(e){i+=t[e]+","}),i=i.replace(/,$/,"\n"),Ext.each(e,function(e){Ext.each(Object.keys(t),function(t){e[t]?"object"==typeof e[t]?e[t].FormattedID?i+=Ext.String.format('"{0}",',e[t].FormattedID):e[t].Name?i+=Ext.String.format('"{0}",',e[t].Name):isNaN(Date.parse(e[t]))?i+=Ext.String.format('"{0}",',e[t].toString()):i+=Ext.String.format('"{0}",',Rally.util.DateTime.formatWithDefaultDateTime(e[t])):i+=Ext.String.format('"{0}",',e[t]):i+=","},this),i=i.replace(/,$/,"\n")},this),i},_getCSVFromWsapiBackedGrid:function(e){for(var t=Ext.create("Deft.Deferred"),i=Ext.create("Rally.data.wsapi.Store",{fetch:e.getStore().config.fetch,filters:e.getStore().config.filters,model:e.getStore().config.model,limit:1/0,pageSize:1/0}),r=e.columns,o=this._getHeadersFromGrid(e),n=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),a=e.getStore().pageSize,s=Math.ceil(n/a),l=[],c=1;c<=s;c++)l.push(this.loadStorePage(e,i,r,c,s));return Deft.Promise.all(l).then({success:function(e){var i=[];i.push('"'+o.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){i.push(e)})}),i=i.join("\r\n"),t.resolve(i),Rally.getApp().setLoading(!1)}}),t.promise},_getCSVFromCustomBackedGridWithPaging:function(e){var t=Ext.create("Deft.Deferred"),i=Ext.create("Rally.data.custom.Store",{model:e.getStore().config.model,filters:e.getStore().config.filters,limit:1/0,pageSize:1/0}),r=e.columns,o=this._getHeadersFromGrid(e),n=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),a=e.getStore().pageSize,s=Math.ceil(n/a),l=[];return l.push(this.loadStorePage(e,i,r,page,s)),Deft.Promise.all(l).then({success:function(e){var i=[];i.push('"'+o.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){i.push(e)})}),i=i.join("\r\n"),t.resolve(i),Rally.getApp().setLoading(!1)}}),t.promise},_getCSVFromCustomBackedGrid:function(e){var t=Ext.create("Deft.Deferred"),i=this;Rally.getApp().setLoading("Assembling data for export...");var r=this._getHeadersFromGrid(e),o=Ext.clone(e.getStore()),n=e.columns,a=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),s=e.getStore().pageSize,l=Math.ceil(a/2e4);o.pageSize=2e4;for(var c=[],d=[],u=1;u<=l;u++)c.push(u);return Ext.Array.each(c,function(t){d.push(function(){return i._loadStorePage(e,o,n,t,c.length)})}),Deft.Chain.sequence(d).then({success:function(e){o.pageSize=s,o.loadPage(1);var i=[];i.push('"'+r.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){i.push(e)})}),i=i.join("\r\n"),t.resolve(i),Rally.getApp().setLoading(!1)}}),t.promise},_loadStorePage:function(e,t,i,r,o){var n=Ext.create("Deft.Deferred");return t.loadPage(r,{callback:function(i){for(var r=[],o=0;o<i.length;o++){var a=i[o];r.push(this._getCSVFromRecord(a,e,t))}n.resolve(r)},scope:this}),n.promise},_getHeadersFromGrid:function(e){var t=[],i=e.columns;return Ext.Array.each(i,function(e){(e.dataIndex||e.renderer)&&(e.csvText?t.push(e.csvText.replace("&nbsp;"," ")):e.text&&t.push(e.text.replace("&nbsp;"," ")))}),t},_getColumnNamesFromGrid:function(e){var t=[],i=e.columns;return Ext.Array.each(i,function(e){(e.dataIndex||e.renderer)&&t.push(e.dataIndex)}),t},getCSVFromGrid:function(e,t){return"Ext.data.TreeStore"!=Ext.getClassName(t.getStore())&&"Rally.data.custom.Store"!=Ext.getClassName(t.getStore())?this._getCSVFromWsapiBackedGrid(t):this._getCSVFromCustomBackedGrid(t)},loadStorePage:function(e,t,i,r,o){var n=Ext.create("Deft.Deferred");return t.loadPage(r,{callback:function(i,a,s){var l=[];Rally.getApp().setLoading(Ext.String.format("Page {0} of {1} loaded",r,o));for(var c=0;c<i.length;c++){var d=i[c];l.push(this._getCSVFromRecord(d,e,t))}n.resolve(l)},scope:this}),n},_getCSVFromRecord:function(e,t,i){var r={align:"right",classes:[],cellIndex:9,column:null,columnIndex:9,innerCls:void 0,recordIndex:5,rowIndex:5,style:"",tdAttr:"",tdCls:"x-grid-cell x-grid-td x-grid-cell-headerId-gridcolumn-1029 x-grid-cell-last x-unselectable",unselectableAttr:"unselectable='on'"},o=[],n=t.columns;return Ext.Array.each(n,function(n){if("rallyrowactioncolumn"!=n.xtype)if(n.dataIndex){var a=n.dataIndex,s=e.get(a);!n._csvIgnoreRender&&n.renderer&&(s=n.exportRenderer?n.exportRenderer(s,r,e,0,0,i,t.getView()):n.renderer(s,r,e,0,0,i,t.getView())),o.push(s)}else{s=null;!n._csvIgnoreRender&&n.renderer&&(s=n.exportRenderer?n.exportRenderer(s,r,e,e,0,0,i,t.getView()):n.renderer(s,r,e,e,0,0,i,t.getView()),o.push(s))}},this),'"'+o.join('","')+'"'}}),Ext.define("Rally.technicalservices.Logger",{enableLogging:!1,constructor:function(e){Ext.apply(this,e)},log:function(e){if(this.enableLogging){var t="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",i=[];i=Ext.Array.push(i,[t]),i=Ext.Array.push(i,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,i)}}}),Ext.define("CountVariableSettingsRow",{alias:"widget.countvariablesettingsrow",extend:"Ext.Container",layout:"hbox",cls:"advanced-filter-row",config:{variableName:void 0,artifactType:void 0,query:void 0,addButtonEnabled:!1,removeButtonEnabled:!1},constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},initComponent:function(){this.items=this._getItems(),this.callParent(arguments)},_getItems:function(){if(this._createAddRowButton(),!this.isEmpty){this._createRemoveRowButton(),this._createIdField(),this._createArtifactTypeField(),this._createQueryField();var e=Ext.widget({xtype:"container",layout:"vbox",height:112,flex:1,items:[this.idField,this.artifactTypeField,this.queryField]});return[this.addRowButton,this.removeRowButton,e]}return[this.addRowButton]},getVariableName:function(){return this.idField.getValue()},getArtifactType:function(){return this.artifactTypeField.getValue()},getQuery:function(){return this.queryField.getValue()},disableAddRow:function(){this.addRowButton.addCls("variable-button-disabled"),this.addRowButton.disable()},disableRemoveRow:function(){this.removeRowButton.addCls("variable-button-disabled"),this.removeRowButton.disable()},enableRemoveRow:function(){this.removeRowButton.removeCls("variable-button-disabled"),this.removeRowButton.enable()},enableAddRow:function(){this.addRowButton.removeCls("variable-button-disabled"),this.addRowButton.enable()},isValid:function(){return!!this.idField.getValue()&&!!this.artifactTypeField.getValue()&&this.queryField.validate()},validate:function(){return this.idField.getValue()?this.artifactTypeField.getValue()?this.queryField.getValue()?this.queryField.validate()?null:"Invalid Query.":"Please provide a query.":"Please provide a value for the Artifact Type.":"Please provide a value for the Variable Name."},getCountVariable:function(){if(this.isValid())return{id:this.idField.getValue(),artifactType:this.artifactTypeField.getValue(),query:this.queryField.getValue()}},_createIdField:function(){this.idField=Ext.widget({xtype:"rallytextfield",itemId:"idField",width:"100%",labelAlign:"right",fieldLabel:"Variable Name",labelSeparator:"",emptyText:"Unique Variable Name...",value:this.variableName,margin:"2 0 2 0",validateOnBlur:!0,validator:function(e){return e&&e.length>0},getErrors:function(e){return e&&0!=e.trim().length?[]:["Please provide a value for Variable Name"]},listeners:{validitychange:function(e,t){this.fireEvent("rowvalidate",this)},scope:this}})},_createArtifactTypeField:function(){this.artifactTypeField=Ext.widget({xtype:"tsrecordtypecombobox",itemId:"artifactTypeField",width:"100%",labelAlign:"right",fieldLabel:"Artifact Type",labelSeparator:"",margin:"2 0 2 0",emptyText:"Choose Artifact Type...",value:this.artifactType,valueField:"TypePath",displayField:"Name",validateOnBlur:!0,validateOnChange:!0,validator:function(e){return e&&e.length>0},listeners:{validitychange:function(e,t){this.fireEvent("rowvalidate",this)},scope:this}})},_createQueryField:function(){this.queryField=Ext.widget({xtype:"textarea",fieldLabel:null,width:"100%",labelAlign:"right",labelSeparator:"",fieldLabel:"Query",margin:"2 0 2 0",flex:1,name:"counterQuery",cls:"query-field",plugins:["rallyfieldvalidationui"],emptyText:"Type a Rally Query like ( ObjectID > 0 )...",value:this.query||"(ObjectID > 0)",validateOnBlur:!0,validateOnChange:!1,validator:function(e){if(!e)return"Query is required.";try{return e&&Rally.data.wsapi.Filter.fromQueryString(e),!0}catch(e){return e.message}},listeners:{validitychange:function(){this.fireEvent("rowvalidate",this)},scope:this}})},_createAddRowButton:function(){var e="variable-button-disabled";this.addButtonEnabled&&(e=""),this.addRowButton=Ext.widget({xtype:"rallybutton",itemId:"addRowButton",cls:"rly-small icon-plus filter-row-control variable-button "+e,margin:5,border:0,disabled:!this.addButtonEnabled,listeners:{click:this._addRow,buffer:200,scope:this}})},_createRemoveRowButton:function(){this.removeRowButton=Ext.widget({xtype:"rallybutton",itemId:"removeRowButton",cls:"rly-small icon-minus filter-row-control variable-button",border:0,margin:5,disabled:!1,listeners:{click:this._removeRow,buffer:200,scope:this}})},_addRow:function(){this.fireEvent("addrow",this)},_removeRow:function(e){this.fireEvent("removerow",this,{autoFocus:!1!==e})}}),Ext.define("CountVariableSettingsComponent",{extend:"Ext.form.field.Base",alias:"widget.countvariablesettings",fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',layout:"vbox",cls:"advanced-filter-panel",header:!1,maxHeight:350,minHeight:50,border:!1,overflowY:"auto",config:{value:void 0},onRender:function(){this.callParent(arguments);var e=this.value;Ext.isString(e)&&(e=Ext.JSON.decode(e)),this._buildItems(e)},_buildItems:function(e){var t=[];this.countVariableRows=[],Ext.Array.each(e,function(i,r){var o=r===e.length-1,n=this._getRowConfig(i);n.addButtonEnabled=o,n.removeButtonEnabled=!0;var a=Ext.widget(n);t.push(a),this.countVariableRows.push(a)},this);var i=this.maxHeight;Ext.isEmpty(t)&&(this._emptyRow=Ext.widget(this._getEmptyRowConfig()),t.push(this._emptyRow),i=this.minHeight),this._countVariableContainer=Ext.widget({xtype:"container",renderTo:this.inputEl,maxHeight:300,height:i,autoScroll:!0,itemId:"countVariableContainer",layout:{type:"vbox",align:"stretch"},cls:"filters-container",items:t}),Ext.isEmpty(t)&&this._countVariableContainer.setHeight(this.minHeight)},_getRowConfig:function(e){return e||(e={}),{xtype:"countvariablesettingsrow",variableName:e.id||"",artifactType:e.artifactType||"HierarchicalRequirement",query:e.query||"",listeners:{addrow:function(){this._addRow(!0)},removerow:this._removeRow,rowvalidate:this._toggleRowButtons,scope:this}}},_getEmptyRowConfig:function(){return{xtype:"countvariablesettingsrow",isEmpty:!0,addButtonEnabled:!0,itemId:"emptyRow",listeners:{addrow:function(){this._addRow(!0)},scope:this}}},_addEmptyRow:function(){this._emptyRow=Ext.widget(this._getEmptyRowConfig()),this._countVariableContainer.add(this._emptyRow),this._countVariableContainer.setHeight(this.minHeight)},_removeEmptyRow:function(){this._emptyRow&&(this._countVariableContainer.remove(this._emptyRow),this._emptyRow.destroy(),this._countVariableContainer.setHeight(this.maxHeight))},_addRow:function(e){Ext.isEmpty(this.countVariableRows)&&this._removeEmptyRow();var t=Ext.widget(this._getRowConfig());this.countVariableRows.push(t),this._countVariableContainer.add(t)},_removeRow:function(e,t){var i=Math.max(0,_.findIndex(this.countVariableRows,e)-1);_.remove(this.countVariableRows,e),this._countVariableContainer.remove(e),Ext.isEmpty(this.countVariableRows)?this._addEmptyRow():t.autoFocus&&this.countVariableRows[i].valueField&&this.countVariableRows[i].queryField.focus();var r=_.last(this.countVariableRows);!Ext.isEmpty(r)&&r.isValid()&&r.enableAddRow(),this._toggleRowButtons(r)},_toggleRowButtons:function(e){Ext.isEmpty(e)||(e.isValid()&&e===_.last(this.countVariableRows)?e.enableAddRow():e.disableAddRow(),1===this.countVariableRows.length||e.enableRemoveRow())},getSubmitData:function(){var e={};return e[this.name]=Ext.JSON.encode(this._getData()),e},_getData:function(){var e=[];return Ext.Array.each(this.countVariableRows,function(t){e.push(t.getCountVariable())}),e},getErrors:function(){var e=[],t=[];return Ext.Array.each(this.countVariableRows,function(i){var r=i.validate();r&&e.push(r),Ext.Array.contains(t,i.getVariableName())?e.push("Duplicate Variable Names {"+i.getVariableName()+"}.  Variable Names must be unique."):t.push(i.getVariableName())}),_.uniq(e)},setValue:function(e){this.callParent(arguments),this._value=e}}),Ext.define("Rally.technicalservices.querycounter.Settings",{singleton:!0,getFields(e){let t=[];return t.push({name:"countVariables",fieldLabel:null,labelAlign:"top",xtype:"countvariablesettings",width:.9*e.width||600,margin:10}),t.push({xtype:"container",margin:"10 70 0 60",html:'<div class="variable-label">Display Text</div><span style="color:#999999;">Enter the text to display in the App.  Use the format of <b>{&lt;Variable Name&gt;}</b> to place the results of the count queries defined above.</span>'}),t.push({name:"html",flex:1,xtype:"rallyrichtexteditor",margin:"10 70 0 60",fieldLabel:"Informational Text",_createResizer(){},resizeable:!1}),t}}),Ext.define("Rally.technicalservices.RecordTypeComboBox",{extend:"Rally.ui.combobox.ComboBox",alias:"widget.tsrecordtypecombobox",constructor:function(e){var t={defaultSelectionPosition:"last",editable:!1,fieldLabel:"",context:Rally.environment.getContext(),storeConfig:{autoLoad:!1,remoteFilter:!0,model:Ext.identityFn("TypeDefinition"),sorters:{property:"Name",direction:"Asc"},filters:[{property:"Creatable",operator:"=",value:"true"}]}};e.storeConfig&&(delete e.storeConfig.autoLoad,e.storeConfig.additionalFilters&&(t.storeConfig.filters=t.storeConfig.filters.concat(e.storeConfig.additionalFilters))),this.callParent([Ext.Object.merge(t,e)])},initComponent:function(){this.callParent(),Deft.Promise.all([this._loadStore()]).then({success:function(e){this.on("change",this._onValueChange,this),this.onReady({preferencesLoaded:!0,record:this.getRecord()})},scope:this})},onReady:function(e){(e=e||{}).preferencesLoaded&&(this.fireEvent("select",e.record),this.callParent(arguments))},getSelectedType:function(){return this.getTypeFromRef(this.getValue())},getTypeFromRef:function(e){return this.getStore().findRecord("_ref",e)},getTypeWithOrdinal:function(e){return this.getStore().findRecord("Ordinal",e)},getAllTypeNames:function(){return _.map(this.getStore().getRecords(),function(e){return e.get("TypePath")})},_onValueChange:function(e,t){this.savePreference(t)},_loadStore:function(){var e=new Deft.Deferred;return this.store.load({callback:function(t,i,r){r?e.resolve():e.reject()},scope:this}),e.promise},getPreference:function(){var e=new Deft.Deferred;return Rally.data.PreferenceManager.load(Ext.apply(this._getPreferenceConfig(),{success:function(t){e.resolve(t[this._getPreferenceName()])},scope:this})),e.promise},savePreference:function(e){var t={};t[this._getPreferenceName()]=e,Rally.data.PreferenceManager.update(Ext.apply(this._getPreferenceConfig(),{settings:t}))},_getPreferenceConfig:function(){var e={filterByUser:!0,filterByName:this._getPreferenceName()};return this.context.get&&this.context.get("appID")&&(e.appID=this.context.get("appID")),e},_getPreferenceName:function(){return this.preferenceName+"-"+this.context.getWorkspace().ObjectID},_isPrefValueInStore:function(e){return this.store.findRecord(this.valueField,e)}}),Ext.define("TSQueryCounter",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,items:[{xtype:"container",layout:{type:"hbox",align:"middle"},items:[{id:Utils.AncestorPiAppFilter.RENDER_AREA_ID,xtype:"container",flex:1,layout:{type:"hbox",align:"middle",defaultMargins:"0 10 10 0"}},{xtype:"rallybutton",style:{float:"right"},cls:"secondary rly-small",frame:!1,itemId:"export-menu-button",iconCls:"icon-export"}]},{xtype:"container",itemId:"display_box"}],config:{defaultSettings:{countVariables:[{artifactType:"Defect",query:"( ObjectID > 0 )",id:"defectCount"},{artifactType:"HierarchicalRequirement",query:"( ObjectID > 0 )",id:"storyCount"}],html:"Defects: {defectCount} or Stories: {storyCount}<br/><br/><em>Use the gear to make App Settings...</em>"}},currentValues:[],launch(){this.down("#export-menu-button").on("click",this._onExport,this),this._validateSettings(),this.ancestorFilterPlugin=Ext.create("Utils.AncestorPiAppFilter",{ptype:"UtilsAncestorPiAppFilter",pluginId:"ancestorFilterPlugin",settingsConfig:{labelWidth:150,margin:10},listeners:{scope:this,ready(e){e.addListener({scope:this,select(){this._runApp()}}),this._reloadModel().then({scope:this,success:this._runApp})}}}),this.addPlugin(this.ancestorFilterPlugin)},_onExport(){let e=["Variable Name,Value"];_.each(this.currentValues,(t,i)=>{e.push([i,t].join(","))}),e=e.join("\r\n"),CArABU.technicalservices.FileUtilities.saveCSVToFile(e,"query-counter.csv")},_validateSettings(){let e=this._getCountVariables(),t=this.getSetting("html");this.logger.log("setting ",this.getSettings());let i=[];Ext.Array.each(e,e=>{let r=Ext.String.format("{{0}}",e.id);new RegExp(r).exec(t)||i.push(`Variable Name ${r} not used.`)}),i.length>0&&Rally.ui.notify.Notifier.showError({message:i.join("<br/>"),allowHTML:!0})},onTimeboxScopeChange(e){this.callParent(arguments),this._runApp()},_timeboxScopeIsValidForArtifactType(e,t){if(e){let i=this.models[t];this.logger.log("_timeboxScopeIsValidForArtifactType",e.getType(),i,i.getField("Milestones"),i.getField("Iteration"),i.getField("Release"),e.getQueryFilter().toString());let r="Release";switch(e.getType()){case"iteration":r="Iteration";break;case"milestone":r="Milestones"}return i.getField(r)?(this.logger.log("TimeboxScope",e.getType(),"is valid for",t),!0):(this.logger.log("TimeboxScope",e.getType(),"NOT valid for",t),!1)}return this.logger.log("No Timebox Scope"),!0},_getCountVariables(){let e=this.getSetting("countVariables");return Ext.isString(e)&&(e=JSON.parse(e)),e},_getModelNames(){let e=this._getCountVariables();this.logger.log("countVariables ",e);let t=Ext.Array.map(e,e=>e.artifactType);return _.uniq(t)},_reloadModel(){let e=Ext.create("Deft.Deferred");return Ext.isEmpty(this._getModelNames())&&e.resolve(),Rally.data.ModelFactory.getModels({types:this._getModelNames(),scope:this,success(t){this.logger.log("models ",t),this.models=t,e.resolve()}}),e.promise},_runApp(){let e=this.getContext().getTimeboxScope(),t=this._getCountVariables(),i=[];this.logger.log("_runApp",t),Ext.Array.each(t,function(t){let{artifactType:r}=t,{query:o}=t,{id:n}=t,a=null;e&&this._timeboxScopeIsValidForArtifactType(e,r)&&(a=e.getQueryFilter(),this.logger.log("Using Timebox Scope >>",a.toString(),a)),Ext.isEmpty(o)||(a=a?a.and(Rally.data.wsapi.Filter.fromQueryString(o)):Rally.data.wsapi.Filter.fromQueryString(o));let s=this.ancestorFilterPlugin.getFilterForType(r);s&&(a=a.and(s));let l=this._loadRecordCount(r,a||[],n);i.push(l)},this),i.length>0?(this.setLoading("Counting..."),Deft.Promise.all(i).then({success:this._updateDisplay,failure:this._showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this)):this._updateDisplay()},_showErrorNotification(e){this.logger.log("_showErrorNotification",e),Rally.ui.notify.Notifier.showError({message:e})},_loadRecordCount(e,t,i){let r=Ext.create("Deft.Deferred"),o=this;this.logger.log("Starting load: model >>",e,"filters>>",t.toString());let n={model:e,filters:t,limit:1,pageSize:1};return this.searchAllProjects()&&(n.context={project:null}),Ext.create("Rally.data.wsapi.Store",n).load({callback(e,t,n){let a={};n?(o.logger.log("result:",t),a[i]=t.resultSet.totalRecords||0,r.resolve(a)):(o.logger.log("Failed: ",t),a[i]=`<span class="error-counter">#ERROR: ${t.error.errors.join(". ")}</span>`,r.resolve(a))}}),r.promise},_updateDisplay(e){e||(e=[]),e=_.reduce(e,(e,t)=>e=_.extend(e,t),{}),this.currentValues=e,this.logger.log("_updateDisplay",e);let t=this.getSetting("html"),i=new Ext.XTemplate(t),r=this.down("#display_box");r.removeAll(),r.add({xtype:"container",tpl:i,cls:"default-counter"}).update(e)},isExternal(){return void 0===this.getAppId()},isMilestoneScoped(){let e=!1,t=this.getContext().getTimeboxScope();return t&&"milestone"==t.getType()&&(e=!0),e},searchAllProjects(){return this.ancestorFilterPlugin.getIgnoreProjectScope()},getSettingsFields(){return Rally.technicalservices.querycounter.Settings.getFields({width:this.getWidth()})}});

               Rally.launchApp('TSQueryCounter', {
                   name: 'query-counter'
               });
        });
    </script>

    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
.error-counter {
  color: red;
}

.default-counter {
   font-family: ProximaNova, Helvetica, Arial;
   font-size: 14px;
}

.variable-label {
  font-family: ProximaNovaSemiBold, Helvetica, Arial;
  text-transform: uppercase;
  font-size:11px;
}

.variable-button{
   border-bottom-left-radius: 2px;
   border-bottom-right-radius: 2px;
   border-top-left-radius: 2px;
   border-top-right-radius: 2px;
   border-bottom-style: none;
   border-left-style: none;
   border-right-style: none;
   border-top-style: none;
   font-size:16px;
   padding-top: 3px;
   width: 16px;
   height: 33px;
   line-height: 16px;
   left: 21px;
   background-clip: border-box;
   background-color: #e6e6e6;
   border-color: #e6e6e6;
   color: #00a9e0;
}

.variable-button-disabled{
   color: #d6d6d6;
}

    </style>

</head>
<body></body>
</html>